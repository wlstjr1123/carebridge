{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" href="{% static 'core/img/favicon.png' %}" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>진료 기록 선택</title>

    {% load static %}
    <link rel="stylesheet" href="{% static 'emr/css/medical_record_inquiry.css' %}">
</head>
<body>

    {% include "core/_header.html" %}

    <div class="container">
        <h2> 진료 기록 선택</h2>
        
        <div class="card">
            <h3>환자 정보</h3>
            <div class="patient-detail-card">
                <div><strong>환자명:</strong> {{ patient.name }}</div>
                <div><strong>환자번호:</strong> P{{ patient.user_id|add:"0000000" }}</div>
                <div><strong>성별/나이:</strong> {{ gender_display }} / {{ age }}세</div>

                <div><strong>주민번호:</strong> {{ resident_reg_no_display }}</div>
                <div><strong>전화번호:</strong> {{ patient.phone }}</div>
                <div><strong>최종 진료일:</strong> {{ recent_visit_date }}</div>
            </div>
        </div>


        <div class="card previous-records-grid-container">
            <h3>방문 기록 (최근 진료일 기준)</h3>

            <div class="visit-box-grid">

    {% for column in visit_columns %}
    <div class="visit-column">
    {% for v in column %}
    <div class="visit-box-wrapper">

        <!-- 방문 헤더 -->
        <div class="visit-box-header"
             aria-expanded="false"
             onclick="toggleAccordionBox(this, 'visit-{{ v.record_id }}')">
            <span>{{ v.date }}</span>
            <span class="toggle-icon">▼</span>
        </div>

        <div class="accordion-content" id="visit-{{ v.record_id }}" style="display:none;">

            {# ------------------------------ #}
            {#  진료기록                     #}
            {# ------------------------------ #}
            {% if v.consult %}
            <div class="level-2-item" aria-expanded="false" onclick="toggleAccordion(this)">
                진료기록 <span class="toggle-icon">▼</span>
            </div>
            <div class="accordion-content" style="display:none;">
                <div class="level-3-detail"
                    onclick="showDetail(this)"
                    data-type="진료기록"
                    data-date="{{ v.datetime_display }}"
                    data-doc="{{ v.doctor }}"
                    data-rec-type="{{ v.consult.type }}"
                    data-content="{{ v.consult.content }}"
                    data-status="완료">
                    - {{ v.consult.type }} / {{ v.datetime_display }}
                </div>
            </div>
            {% endif %}

            {# ------------------------------ #}
            {#  검사 오더                     #}
            {# ------------------------------ #}
            {% if v.lab %}
            <div class="level-2-item" aria-expanded="false" onclick="toggleAccordion(this)">
                검사 오더 <span class="toggle-icon">▼</span>
            </div>
            <div class="accordion-content" style="display:none;">
                {% for lab in v.lab %}
                <div class="level-3-detail"
                    onclick="showDetail(this)"
                    data-type="검사"
                    data-date="{{ lab.status_datetime_display }}"
                    data-doc="{{ v.doctor }}"
                    data-rec-type="{{ lab.lab_nm }}"
                    data-content="{{ lab.specimen_cd }}"
                    data-status="{{ lab.status }}"
                    data-attachments="{{ lab.attachments_json|default:'[]'|escape }}">
                    - {{ lab.lab_nm }} / {{ lab.status }} / {{ lab.status_datetime_display }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {# ------------------------------ #}
            {#  처방                          #}
            {# ------------------------------ #}
            {% if v.prescriptions %}
            <div class="level-2-item" aria-expanded="false" onclick="toggleAccordion(this)">
                처방 <span class="toggle-icon">▼</span>
            </div>
            <div class="accordion-content" style="display:none;">
                {% for p in v.prescriptions %}
                <div class="level-3-detail"
                    onclick="showDetail(this)"
                    data-type="처방"
                    data-date="{{ v.datetime_display }}"
                    data-doc="{{ v.doctor }}"
                    data-rec-type="{{ p.order_name }}"
                    data-content="{{ p.dose }} / {{ p.frequency }}"
                    data-status="처방"
                    data-drug-name="{{ p.order_name }}"
                    data-drug-code="{{ p.order_code }}"
                    data-drug-frequency="{{ p.frequency }}"
                    data-drug-dose="{{ p.dose }}"
                    data-notes="{{ p.notes }}">
                    - {{ p.order_name }} / {{ p.dose }} / {{ p.frequency }} / {{ v.datetime_display }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {# ------------------------------ #}
            {#  치료·처치 기록                #}
            {# ------------------------------ #}
            {% if v.treatment %}
            <div class="level-2-item" aria-expanded="false" onclick="toggleAccordion(this)">
                치료·처치 기록 <span class="toggle-icon">▼</span>
            </div>
            <div class="accordion-content" style="display:none;">
                {% for tr in v.treatment %}
                <div class="level-3-detail"
                    onclick="showDetail(this)"
                    data-type="치료"
                    data-date="{{ tr.execution_datetime_display }}"
                    data-doc="{{ v.doctor }}"
                    data-rec-type="{{ tr.procedure_name }}"
                    data-content="{{ tr.result_notes }}"
                    data-status="{{ tr.status }}">
                    - {{ tr.procedure_name }} / {{ tr.status }} / {{ tr.execution_datetime_display }}
                </div>
                {% endfor %}
            </div>
            {% endif %}


        </div>
    </div>
    {% endfor %}
    </div>
    {% endfor %}

            </div>
  

        <div class="card" id="detailView" style="display: none;">
            <h4>선택된 이벤트 상세정보</h4>
            <div id="detailContent"></div>
        </div>

    </div><!-- container -->

    <script src="{% static 'emr/js/medical_record_inquiry.js' %}"></script>
</body>
</html>
