{% extends "emergency/base.html" %}
{% load static %}
{% load status_filters %}

{% block title %}실시간 응급실 조회{% endblock %}

{% block content %}

<header>
  <h1>실시간 응급실 조회</h1>
</header>

<div class="control-row">
  <button class="btn" onclick="openRegionModal()">지역 선택</button>
  {% if selected_region %}
    <span id="region-summary" class="region-summary">{{ selected_region }}</span>
  {% endif %}
  <button class="btn" onclick="openFilterModal()">필터</button>

  <!-- 거리순 정렬 버튼 + 툴팁 -->
  <div class="sort-control-wrapper">
    <button class="btn" onclick="sortByDistance()">가장 가까운 응급실</button>
    <div class="tooltip-wrapper">
      <span class="tooltip-icon"></span>
      <div class="tooltip-content">
        <div class="tooltip-header">
        </div>
        <div class="tooltip-text" id="tooltip-text"></div>
      </div>
    </div>
  </div>
</div>

<!-- 현재 정렬 기준 표시 -->
<div class="sort-criteria-display" id="sort-criteria-display">
  현재 정렬 기준: <span id="sort-criteria-text"></span>
</div>

<!-- 선택된 필터 태그 -->
<div id="filter-tags-container" class="filter-tags hidden">
  <div class="filter-tags-label">필터 결과</div>

  <div id="filter-tags" style="
        display:flex;
        flex-wrap:nowrap;
        align-items:center;
        gap:8px;
        overflow-x:auto;
        padding:6px 0;
  "></div>

  <button id="filter-tags-reset" class="filter-reset-btn">선택 초기화</button>
</div>


<div class="table-box">
  <div class="table-header">
    <div>기관명</div>
    <div>응급실 일반</div>
    <div>응급실 소아</div>
    <div>분만실</div>
    <div>음압격리</div>
    <div>일반격리</div>
    <div>코호트격리</div>
    <div></div>
  </div>

  {% for hos in hospitals %}
    {% with st=hos.latest_status %}
      <div class="row" data-er-id="{{ hos.er_id }}" onclick="openHospitalDetail('{{ hos.er_id }}')">

        <div>
          <div class="h-name">
            {{ hos.er_name }}
            {% if st and st.hvdate %}
              <span class="update-time" data-hvdate="{{ st.hvdate|date:'Y-m-d H:i:s' }}"></span>
            {% endif %}
          </div>
          <div class="h-subinfo">
            {% if hos.distance_km %}
              {{ hos.distance_km|floatformat:1 }}km | 
            {% endif %}
            {{ hos.er_sido }} {{ hos.er_sigungu }}
          </div>
        </div>

        {# 응급실 일반 #}
        <div>
          {% if st %}
            {% include "emergency/_circle_cell.html" with available=st.er_general_available total=st.er_general_total type_name="er_general" %}
          {% else %}
            {% include "emergency/_circle_cell.html" with available=None total=None type_name="er_general" %}
          {% endif %}
        </div>

        {# 응급실 소아 #}
        <div>
          {% if st %}
            {% include "emergency/_circle_cell.html" with available=st.er_child_available total=st.er_child_total type_name="er_child" %}
          {% else %}
            {% include "emergency/_circle_cell.html" with available=None total=None type_name="er_child" %}
          {% endif %}
        </div>

        {# 분만실 (hv42/hvs26 → birth_available/birth_total) #}
        <div>
          {% if st %}
            {% include "emergency/_circle_cell.html" with available=st.birth_available total=st.birth_total type_name="birth" %}
          {% else %}
            {% include "emergency/_circle_cell.html" with available=None total=None type_name="birth" %}
          {% endif %}
        </div>

        {# 음압격리 #}
        <div>
          {% if st %}
            {% include "emergency/_circle_cell.html" with available=st.negative_pressure_available total=st.negative_pressure_total type_name="negative_pressure" %}
          {% else %}
            {% include "emergency/_circle_cell.html" with available=None total=None type_name="negative_pressure" %}
          {% endif %}
        </div>

        {# 일반격리 #}
        <div>
          {% if st %}
            {% include "emergency/_circle_cell.html" with available=st.isolation_general_available total=st.isolation_general_total type_name="isolation_general" %}
          {% else %}
            {% include "emergency/_circle_cell.html" with available=None total=None type_name="isolation_general" %}
          {% endif %}
        </div>

        {# 코호트격리 (hv27/hvs59 → isolation_cohort_available/total) #}
        <div>
          {% if st %}
            {% include "emergency/_circle_cell.html" with available=st.isolation_cohort_available total=st.isolation_cohort_total type_name="isolation_cohort" %}
          {% else %}
            {% include "emergency/_circle_cell.html" with available=None total=None type_name="isolation_cohort" %}
          {% endif %}
        </div>

        <div class="favorite {% if hos.is_favorite %}on{% endif %}" 
             data-er-id="{{ hos.er_id }}">★</div>
      </div>
    {% endwith %}
  {% empty %}
  <div class="row empty-message">
    <div>표시할 병원 데이터가 없습니다.</div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </div>
  {% endfor %}

</div>

{% include "emergency/_modal_region.html" %}
{% include "emergency/_modal_filter.html" %}
{% include "emergency/_modal_detail.html" %}

<script>
  // 템플릿에서 전달된 초기값 설정 (session 기반)
  window.regionDict = JSON.parse('{{ region_dict_json|safe }}');
  window.selectedSido = '{{ selected_sido|default:"" }}';
  window.selectedSigungu = '{{ selected_sigungu|default:"" }}';
  window.selectedEtype = '{{ selected_etype|default:"" }}';
  window.selectedFilters = JSON.parse('{{ selected_filters|safe }}');
  window.selectedSort = '{{ selected_sort|default:"score" }}';
  
  // URL 전역 변수 설정 (JS 파일에서 사용)
  window.toggleErFavoriteUrl = '{% url "toggle_er_favorite" %}';
  window.loginUrl = '{% url "accounts:login" %}';
</script>

<script src="{% static 'core/js/home.js' %}"></script>

{% endblock %}

